# File that is for deployment from docker to google cloud
# With build


# Defines what branch the yaml file will activate on
on:
  push:
    branches: [ main ]


# Jobs tab:
jobs:
  build-push-gcr:
    name: Build and Push to GCP
    runs-on: ubuntu-latest
  steps:
  - name: Checkout
    uses: actions/checkout@v4
  
  # Part for the google cloud image configuration, pulled from git secret keys
  # This is going to be in whatever reporsitory you made
  - uses: google-github-actions/setup-gcloud@master
    with:
      service_account_key: ${{ secrets.SERVICE_ACCOUNT_KEY }}
      project_id: ${{ env.PROJECT_ID }}
      export_default_credentials: true

  # Creating a docker image from current dir
  - name: Build Docker Image
    run: docker build -t $IMAGE_NAME:latest .

  - name: Configure Docker Client
    run: |-
      gcloud auth configure-docker --quiet

  # Push the image to conatiner registry on google cloud
  - name: Push Docker Image to Container Registry (GCR)
    env:
      GIT_TAG: v0.1.0
    run: |-
      docker tag $IMAGE_NAME:latest gcr.io/$PROJECT_ID/$IMAGE_NAME:latest
      docker tag $IMAGE_NAME:latest gcr.io/$PROJECT_ID/$IMAGE_NAME:$GIT_TAG
      docker push gcr.io/$PROJECT_ID/$IMAGE_NAME:latest
      docker push gcr.io/$PROJECT_ID/$IMAGE_NAME:$GIT_TAG


# Pushing that image to google cloud run